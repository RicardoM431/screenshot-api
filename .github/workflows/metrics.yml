name: Daily Metrics Update

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Count signups from Vercel logs
        id: count
        run: |
          # Get signup count from Vercel logs
          COUNT=$(vercel logs --token=${{ secrets.VERCEL_TOKEN }} --output=raw | grep "ðŸ“§ NEW SIGNUP" | wc -l)
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          echo "Found $COUNT signups"

      - name: Update metrics file
        run: |
          npm run metrics update ${{ steps.count.outputs.count }}

      - name: Commit updated metrics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add validation-metrics.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Auto-update metrics: ${{ steps.count.outputs.count }} signups"
            git push
          fi

      - name: Create daily report issue
        uses: actions/github-script@v7
        with:
          script: |
            const count = ${{ steps.count.outputs.count }};
            const goal = 50;
            const progress = Math.round((count / goal) * 100);
            const daysElapsed = Math.ceil((Date.now() - new Date('2025-10-14').getTime()) / (1000 * 60 * 60 * 24));
            const daysRemaining = Math.max(0, 7 - daysElapsed);

            let status = 'âš ï¸ Behind Target';
            if (count >= goal) status = 'âœ… Goal Achieved!';
            else if (count >= 25) status = 'ðŸŸ¡ On Track';

            const body = `## Daily Metrics Report

            **Date:** ${new Date().toLocaleDateString()}
            **Day:** ${daysElapsed} of 7

            ### Progress
            - **Signups:** ${count} / ${goal}
            - **Progress:** ${progress}%
            - **Status:** ${status}
            - **Days Remaining:** ${daysRemaining}

            ### Rate
            - **Daily Average:** ${(count / daysElapsed).toFixed(1)} signups/day
            - **Projected Total:** ${Math.round((count / daysElapsed) * 7)} signups

            ### Action Items
            ${count < 25 ? '- âš ï¸ **Urgent:** Share more aggressively\n- Post on additional platforms\n- Improve messaging' : ''}
            ${count >= 25 && count < 50 ? '- ðŸŸ¡ **Continue:** Keep sharing daily\n- Engage with comments\n- Track conversion rate' : ''}
            ${count >= 50 ? '- âœ… **Success:** Begin Week 2 build phase\n- Email waitlist\n- Prepare build timeline' : ''}

            ---
            *Auto-generated by GitHub Actions*
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š Metrics Update: Day ${daysElapsed} - ${count} signups`,
              body: body,
              labels: ['metrics', 'validation']
            });
